<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatter ‚Äî Minimal Social Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1020; --panel: #121735; --muted: #93a5fd; --text: #e8eeff; --accent: #6c7cff; --accent-2: #16db65; --danger: #ff5c7a;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; background: linear-gradient(120deg, #0b1020, #141a3f); color: var(--text); font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .app { display: grid; grid-template-columns: 280px 1fr; min-height: 100vh; }
    .sidebar { background: rgba(18, 23, 53, .7); backdrop-filter: blur(8px); border-right: 1px solid rgba(255, 255, 255, .08); padding: 16px; display: flex; flex-direction: column; gap: 16px; }
    .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; }
    .logo .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent-2); box-shadow: 0 0 18px var(--accent-2); }
    .card { background: rgba(255, 255, 255, .04); border: 1px solid rgba(255, 255, 255, .08); border-radius: 16px; }
    .user-card { display: flex; align-items: center; gap: 10px; padding: 12px; }
    .user-card img { width: 36px; height: 36px; border-radius: 50%; }
    .btn, button, input, textarea, select { font-family: inherit; }
    .btn { padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, .15); background: rgba(255, 255, 255, .05); color: var(--text); cursor: pointer; }
    .btn.primary { background: var(--accent); border-color: transparent; }
    .btn.ghost { background: transparent; border-color: rgba(255, 255, 255, .1); }
    .btn.full { width: 100%; }
    .btn.danger { background: var(--danger); border-color: transparent; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn.new-message { background: var(--accent-2); border-color: transparent; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }
    .muted { color: #a8b0d6; font-size: .9rem; }
    .search { display: flex; gap: 8px; padding: 10px; }
    .search input { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, .12); background: rgba(0, 0, 0, .2); color: var(--text); }
    .nav { display: flex; flex-direction: column; gap: 8px; padding: 10px; }
    .nav .item { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 10px; cursor: pointer; position: relative; }
    .nav .item.active, .nav .item:hover { background: rgba(255, 255, 255, .08); }
    .nav .item.new::after { content: ''; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 8px; height: 8px; background: var(--accent-2); border-radius: 50%; }
    .chats { display: flex; flex-direction: column; gap: 6px; padding: 8px; overflow: auto; }
    .chat-row { display: grid; grid-template-columns: 46px 1fr auto; gap: 10px; padding: 10px; border-radius: 12px; cursor: pointer; position: relative; }
    .chat-row:hover { background: rgba(255, 255, 255, .06); }
    .chat-row.new { background: rgba(22, 219, 101, 0.1); border-left: 3px solid var(--accent-2); }
    .chat-row img { width: 46px; height: 46px; border-radius: 50%; }
    .chat-row .name { font-weight: 600; }
    .chat-row .last { color: #b7bde3; font-size: .92rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .main { display: flex; flex-direction: column; height: 100vh; }
    .topbar { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid rgba(255, 255, 255, .08); background: rgba(18, 23, 53, .6); backdrop-filter: blur(8px); }
    .topbar .title { display: flex; align-items: center; gap: 10px; }
    .content { position: relative; height: calc(100vh - 56px); }
    .view { position: absolute; inset: 0; display: none; }
    .view.active { display: block; }
    .messages { padding: 14px; overflow: auto; display: flex; flex-direction: column; gap: 8px; height: calc(100% - 86px); }
    .bubble { max-width: 70%; padding: 10px 12px; border-radius: 14px; line-height: 1.35; position: relative; }
    .me { align-self: flex-end; background: linear-gradient(135deg, var(--accent), #8e99ff); }
    .you { align-self: flex-start; background: rgba(255, 255, 255, .08); }
    .bubble .time { font-size: .75rem; margin-top: 2px; opacity: 0.7; }
    .me .time { text-align: right; }
    .you .time { text-align: left; }
    .composer { display: grid; grid-template-columns: 1fr auto; gap: 10px; padding: 12px; border-top: 1px solid rgba(255, 255, 255, .08); background: rgba(0, 0, 0, .15); height: 86px; }
    .composer textarea { resize: none; height: 50px; padding: 10px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, .12); background: rgba(0, 0, 0, .2); color: var(--text); }
    .auth { max-width: 420px; margin: 8vh auto; padding: 20px; }
    .auth .group { display: flex; flex-direction: column; gap: 6px; margin: 8px 0; }
    .auth input { padding: 12px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, .12); background: rgba(0, 0, 0, .2); color: var(--text); }
    .switch { margin-top: 6px; font-size: .95rem; }
    .empty { display: grid; place-items: center; height: 100%; color: #aeb7e9; }
    .pill { padding: 6px 10px; border-radius: 999px; background: rgba(255, 255, 255, .08); border: 1px dashed rgba(255, 255, 255, .18); }
    .people-wrap { padding: 12px; overflow: auto; height: 100%; display: flex; flex-direction: column; gap: 8px; }
    .person { display: grid; grid-template-columns: 46px 1fr auto; gap: 10px; padding: 10px; border-radius: 12px; background: rgba(255, 255, 255, .04); border: 1px solid rgba(255, 255, 255, .06); }
    .person img { width: 46px; height: 46px; border-radius: 50%; }
    .person .name { font-weight: 600; }
    .person .email { color: #b7bde3; font-size: .92rem; }
    .profile-wrap { padding: 16px; max-width: 720px; }
    .form-row { display: flex; gap: 12px; margin: 10px 0; }
    .form-row input, .form-row textarea { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, .12); background: rgba(0, 0, 0, .2); color: var(--text); }
    @media (max-width: 980px) { .app { grid-template-columns: 1fr; } .sidebar { position: fixed; z-index: 10; inset: 0 30% 0 0; transform: translateX(-100%); transition: .25s; } .sidebar.open { transform: none; } .topbar .menu { display: inline-block; } .topbar .menu button { font-size: 20px; } .topbar .title { gap: 8px; } }
    @media (min-width: 981px) { .topbar .menu { display: none; } }
  </style>
</head>
<body>
<!-- =========== AUTH =========== -->
<div id="authView" class="auth card">
  <div class="logo" style="margin-bottom:12px"><span class="dot"></span> <span>Chatter</span></div>
  <h2 id="authTitle">Create account</h2>
  <div class="group"><label>Name</label><input id="nameInput" placeholder="Ada Lovelace"/></div>
  <div class="group"><label>Email</label><input id="emailInput" type="email" placeholder="ada@chatter.app"/></div>
  <div class="group"><label>Password</label><input id="passwordInput" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
  <div class="group"><button class="btn primary full" id="authSubmit">Sign up</button></div>
  <div class="group"><button class="btn full" id="googleBtn">Continue with Google</button></div>
  <div class="switch" id="authSwitch">Already have an account? <a href="#" id="toLogin">Sign in</a></div>
  <div class="switch" id="forgotPassword" style="display:none"><a href="#" id="toReset">Forgot password?</a></div>
  <p class="muted" style="margin-top:8px">
    <strong>Security Rules:</strong> Use simple rules allowing authenticated users to read/write everything.
  </p>
</div>

<!-- =========== APP =========== -->
<div id="appView" class="app" hidden>
  <aside class="sidebar" id="sidebar">
    <div class="logo"><span class="dot"></span><span>Chatter</span></div>
    <div class="card user-card">
      <img id="meAvatar" src="https://api.dicebear.com/9.x/thumbs/svg?seed=me" alt="me">
      <div>
        <div id="meName" style="font-weight:600">‚Äî</div>
        <div id="meEmail" class="muted">‚Äî</div>
      </div>
    </div>
    <div class="card search">
      <input id="userSearch" placeholder="Search people by name/email"/>
      <button class="btn" id="inviteBtn">+</button>
    </div>
    <div class="card nav">
      <div class="item active" id="navChats">üí¨ Chats</div>
      <div class="item" id="navPeople">üë• People</div>
      <div class="item" id="navProfile">üôç Profile</div>
      <div class="item" id="navLogout">üö™ Logout</div>
    </div>
    <div class="card" style="padding:8px;">
      <div class="muted" style="padding:8px 8px 0">Recent chats</div>
      <div class="chats" id="recentList"></div>
    </div>
    <div class="muted" style="padding:8px;text-align:center">Built with Firebase</div>
  </aside>
  <main class="main">
    <div class="topbar">
      <div class="title">
        <div class="menu"><button class="btn ghost" id="toggleSidebar">‚ò∞</button></div>
        <div><strong id="pageTitle">Welcome</strong><div id="pageSub" class="muted" style="font-size:.9rem">Select a conversation or find people to start chatting.</div></div>
      </div>
    </div>
    <div class="content">
      <section id="chatView" class="view active">
        <div class="messages" id="messages"></div>
        <div class="composer" id="composer" hidden>
          <textarea id="messageInput" placeholder="Type a message‚Ä¶"></textarea>
          <button class="btn primary" id="sendBtn">Send</button>
        </div>
        <div class="empty" id="emptyState"><div class="pill">No chat selected</div></div>
      </section>
      <section id="peopleView" class="view">
        <div class="people-wrap" id="peopleList"></div>
      </section>
      <section id="profileView" class="view">
        <div class="profile-wrap card">
          <h2>My Profile</h2>
          <div class="form-row">
            <input id="profileName" placeholder="Your name">
          </div>
          <div class="form-row">
            <input id="profilePhoto" placeholder="Photo URL">
          </div>
          <div class="form-row">
            <textarea id="profileBio" placeholder="Short bio (optional)"></textarea>
          </div>
          <div class="form-row">
            <button class="btn primary" id="saveProfileBtn">Save Profile</button>
            <button class="btn danger" id="logoutBtn">Logout</button>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<script type="module">
  // Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyC8s2qD5EZ8DixHDV3VkRtQQ6JvwH7p1Hk",
  authDomain: "prac11-20d0a.firebaseapp.com",
  projectId: "prac11-20d0a",
  storageBucket: "prac11-20d0a.firebasestorage.app",
  messagingSenderId: "411675281594",
  appId: "1:411675281594:web:21699db582f3c313ea5a83",
  measurementId: "G-C5H7KRW6Z2"
};

  // Firebase SDKs
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,
    signOut, updateProfile, GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import {
    getFirestore, doc, setDoc, getDoc, addDoc, collection, getDocs,
    serverTimestamp, onSnapshot, orderBy, updateDoc, query, writeBatch
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM refs
  const authView = document.getElementById('authView');
  const appView = document.getElementById('appView');
  const authTitle = document.getElementById('authTitle');
  const nameInput = document.getElementById('nameInput');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const authSubmit = document.getElementById('authSubmit');
  const googleBtn = document.getElementById('googleBtn');
  const forgotPassword = document.getElementById('forgotPassword');
  const toReset = document.getElementById('toReset');

  const meName = document.getElementById('meName');
  const meEmail = document.getElementById('meEmail');
  const meAvatar = document.getElementById('meAvatar');

  const userSearch = document.getElementById('userSearch');
  const inviteBtn = document.getElementById('inviteBtn');
  const navChats = document.getElementById('navChats');
  const navPeople = document.getElementById('navPeople');
  const navProfile = document.getElementById('navProfile');
  const navLogout = document.getElementById('navLogout');

  const pageTitle = document.getElementById('pageTitle');
  const pageSub = document.getElementById('pageSub');

  const recentList = document.getElementById('recentList');
  const sidebar = document.getElementById('sidebar');
  const toggleSidebar = document.getElementById('toggleSidebar');

  const chatView = document.getElementById('chatView');
  const peopleView = document.getElementById('peopleView');
  const profileView = document.getElementById('profileView');

  const messagesEl = document.getElementById('messages');
  const composer = document.getElementById('composer');
  const emptyState = document.getElementById('emptyState');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  const profileName = document.getElementById('profileName');
  const profilePhoto = document.getElementById('profilePhoto');
  const profileBio = document.getElementById('profileBio');
  const saveProfileBtn = document.getElementById('saveProfileBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  const peopleList = document.getElementById('peopleList');

  // State
  let isSignup = true;
  let activeChatId = null;
  let messagesUnsub = null;
  let recentChatsUnsub = null;
  const provider = new GoogleAuthProvider();

  // Helpers
  function debounce(fn, ms) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; }
  function escapeHtml(s) { return s?.replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[c])); }
  function timeAgo(date) { const d = (typeof date === 'number') ? new Date(date) : date; const diff = Math.floor((Date.now() - d.getTime()) / 1000); if (diff < 60) return diff + "s"; if (diff < 3600) return Math.floor(diff / 60) + "m"; if (diff < 86400) return Math.floor(diff / 3600) + "h"; return Math.floor(diff / 86400) + "d"; }
  function composeChatId(a, b) { return a < b ? `${a}_${b}` : `${b}_${a}`; }

  // Simple chat last message update
  async function updateChatLastMessage(chatId, text, senderUid) {
    try {
      const [a, b] = chatId.split('_');
      const otherUid = senderUid === a ? b : a;
      
      // Update main chat
      await updateDoc(doc(db, 'chats', chatId), { 
        lastMessage: text, 
        updatedAt: serverTimestamp() 
      });
      
      // Update sender's chat list
      await updateDoc(doc(db, 'userChats', senderUid, 'items', chatId), { 
        lastMessage: text, 
        updatedAt: serverTimestamp()
      });
      
      // Update recipient's chat list
      await updateDoc(doc(db, 'userChats', otherUid, 'items', chatId), { 
        lastMessage: text, 
        updatedAt: serverTimestamp()
      });
      
      console.log('Chat updated for both users:', chatId);
    } catch (e) {
      console.error('Error updating chat metadata:', e);
    }
  }

  // Function to render messages
  function renderMessages(messagesSnapshot) {
    console.log('Rendering messages, snapshot size:', messagesSnapshot.size);
    messagesEl.innerHTML = '';
    
    if (messagesSnapshot.empty) {
      const noMessages = document.createElement('div');
      noMessages.className = 'empty';
      noMessages.innerHTML = '<div class="pill">No messages yet. Say hi! üëã</div>';
      messagesEl.appendChild(noMessages);
      return;
    }

    messagesSnapshot.forEach((doc) => {
      const messageData = doc.data();
      const isMe = messageData.senderId === auth.currentUser?.uid;
      const bubble = document.createElement('div');
      bubble.className = `bubble ${isMe ? 'me' : 'you'}`;
      
      const messageContent = document.createElement('div');
      messageContent.textContent = messageData.text;
      
      if (messageData.createdAt && messageData.createdAt.toDate) {
        const timeDiv = document.createElement('div');
        timeDiv.className = 'time muted';
        timeDiv.textContent = timeAgo(messageData.createdAt.toDate());
        bubble.appendChild(messageContent);
        bubble.appendChild(timeDiv);
      } else {
        bubble.appendChild(messageContent);
      }
      
      messagesEl.appendChild(bubble);
    });
    
    // Scroll to bottom
    setTimeout(() => {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }, 0);
  }

  // Auth mode
  function setAuthMode(signup) {
    isSignup = signup;
    authTitle.textContent = signup ? 'Create account' : 'Welcome back';
    authSubmit.textContent = signup ? 'Sign up' : 'Sign in';
    nameInput.parentElement.style.display = signup ? 'flex' : 'none';
    forgotPassword.style.display = signup ? 'none' : 'block';
    const sw = document.getElementById('authSwitch');
    sw.innerHTML = signup ? 'Already have an account? <a href="#" id="toLogin">Sign in</a>' : "Don't have an account? <a href='#' id='toSignup'>Create one</a>";
    document.getElementById('toLogin')?.addEventListener('click', e => { e.preventDefault(); setAuthMode(false); });
    document.getElementById('toSignup')?.addEventListener('click', e => { e.preventDefault(); setAuthMode(true); });
  }
  setAuthMode(true);

  // Auth actions
  googleBtn.addEventListener('click', async () => {
    try {
      const cred = await signInWithPopup(auth, provider);
      await ensureUserDoc(cred.user);
    } catch (e) {
      console.error('Google sign-in error:', e);
      alert('Google sign-in failed: ' + e.message);
    }
  });

  authSubmit.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const pass = passwordInput.value.trim();
    if (!email || !pass) { alert('Email and password are required'); return; }
    try {
      if (isSignup) {
        const name = (nameInput.value.trim() || email.split('@')[0]).slice(0, 50);
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, {
          displayName: name,
          photoURL: `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(name)}`
        });
        await ensureUserDoc(cred.user);
      } else {
        await signInWithEmailAndPassword(auth, email, pass);
      }
    } catch (e) {
      console.error('Auth error:', e);
      if (e.code === 'auth/email-already-in-use') {
        alert('Email already exists. Please sign in instead.');
        setAuthMode(false);
        emailInput.value = email;
      } else if (e.code === 'auth/invalid-credential') {
        alert('Invalid email or password.');
      } else {
        alert('Authentication failed: ' + e.message);
      }
    }
  });

  toReset.addEventListener('click', async (e) => {
    e.preventDefault();
    const email = emailInput.value.trim();
    if (!email) { alert('Please enter your email.'); return; }
    try {
      await sendPasswordResetEmail(auth, email);
      alert('Password reset email sent!');
    } catch (e) {
      alert('Error: ' + e.message);
    }
  });

  navLogout.addEventListener('click', doLogout);
  logoutBtn.addEventListener('click', doLogout);

  async function doLogout() {
    try {
      if (messagesUnsub) messagesUnsub();
      if (recentChatsUnsub) recentChatsUnsub();
      activeChatId = null;
      await signOut(auth);
    } catch (e) {
      console.error('Logout error:', e);
    }
  }

  // View switching
  function activateView(view) {
    [chatView, peopleView, profileView].forEach(v => v.classList.remove('active'));
    view.classList.add('active');
    sidebar.classList.remove('open');
  }

  navChats.addEventListener('click', () => {
    pageTitle.textContent = 'Chats';
    pageSub.textContent = 'Your recent conversations';
    activateView(chatView);
  });

  navPeople.addEventListener('click', async () => {
    pageTitle.textContent = 'People';
    pageSub.textContent = 'Find people to chat with';
    activateView(peopleView);
    await loadPeople();
  });

  navProfile.addEventListener('click', async () => {
    pageTitle.textContent = 'My Profile';
    pageSub.textContent = 'Update your information';
    activateView(profileView);
    await loadProfile();
  });

  toggleSidebar.addEventListener('click', () => sidebar.classList.toggle('open'));

  // Auth state
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      console.log('User signed in:', user.uid);
      authView.hidden = true;
      appView.hidden = false;
      meName.textContent = user.displayName || 'Anonymous';
      meEmail.textContent = user.email || '';
      meAvatar.src = user.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${user.uid}`;
      
      if (recentChatsUnsub) recentChatsUnsub();
      loadRecentChats(user.uid);
      navChats.click();
    } else {
      console.log('User signed out');
      appView.hidden = true;
      authView.hidden = false;
      setAuthMode(true);
      messagesEl.innerHTML = '';
      recentList.innerHTML = '';
      if (messagesUnsub) messagesUnsub();
      if (recentChatsUnsub) recentChatsUnsub();
    }
  });

  // Create user doc
  async function ensureUserDoc(user) {
    try {
      const ref = doc(db, 'users', user.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, {
          uid: user.uid,
          name: user.displayName || 'Anonymous',
          email: user.email || '',
          photoURL: user.photoURL || '',
          bio: '',
          createdAt: serverTimestamp()
        });
        console.log('User document created');
      }
    } catch (e) {
      console.error('Error creating user doc:', e);
    }
  }

  // People search
  userSearch.addEventListener('input', debounce(loadPeople, 300));

  async function loadPeople() {
    const me = auth.currentUser;
    if (!me) return;
    
    try {
      const term = userSearch.value.trim().toLowerCase();
      const usersRef = collection(db, 'users');
      const qs = await getDocs(usersRef);
      const all = qs.docs.map(d => d.data()).filter(u => u.uid !== me.uid);
      const filtered = term ? all.filter(u => 
        (u.name || '').toLowerCase().includes(term) || 
        (u.email || '').toLowerCase().includes(term)
      ) : all.slice(0, 50);
      
      peopleList.innerHTML = '';
      if (filtered.length === 0) {
        peopleList.innerHTML = '<div class="empty"><div class="pill">No people found</div></div>';
        return;
      }
      
      filtered.forEach(u => {
        const row = document.createElement('div');
        row.className = 'person';
        row.innerHTML = `
          <img src="${u.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${u.name || u.uid}`}" alt="">
          <div>
            <div class="name">${escapeHtml(u.name || 'User')}</div>
            <div class="email">${escapeHtml(u.email || '')}</div>
          </div>
          <div><button class="btn primary">Chat</button></div>
        `;
        row.querySelector('button').addEventListener('click', () => startChatWith(u.uid));
        peopleList.appendChild(row);
      });
    } catch (e) {
      console.error('Error loading people:', e);
      peopleList.innerHTML = '<div class="empty"><div class="pill">Error loading people</div></div>';
    }
  }

  // Start chat - SIMPLIFIED
  async function startChatWith(otherUid) {
    const me = auth.currentUser;
    if (!me || me.uid === otherUid) return;
    
    try {
      const chatId = composeChatId(me.uid, otherUid);
      console.log('Starting chat:', chatId);
      
      // Create main chat document
      const chatRef = doc(db, 'chats', chatId);
      await setDoc(chatRef, {
        chatId,
        participants: [me.uid, otherUid],
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        lastMessage: ''
      }, { merge: true });
      
      // Create chat reference for current user
      const otherSnap = await getDoc(doc(db, 'users', otherUid));
      const otherData = otherSnap.data();
      
      const myChatRef = doc(db, 'userChats', me.uid, 'items', chatId);
      await setDoc(myChatRef, {
        chatId,
        otherUid,
        otherName: otherData?.name || 'User',
        otherPhoto: otherData?.photoURL || '',
        lastMessage: '',
        updatedAt: serverTimestamp()
      }, { merge: true });
      
      // Create chat reference for other user
      const otherChatRef = doc(db, 'userChats', otherUid, 'items', chatId);
      const meSnap = await getDoc(doc(db, 'users', me.uid));
      const meData = meSnap.data();
      
      await setDoc(otherChatRef, {
        chatId,
        otherUid: me.uid,
        otherName: meData?.name || 'User',
        otherPhoto: meData?.photoURL || '',
        lastMessage: '',
        updatedAt: serverTimestamp()
      }, { merge: true });
      
      console.log('Chat created successfully');
      
      // Open chat
      openChat(chatId, {
        uid: otherUid,
        name: otherData?.name,
        photo: otherData?.photoURL,
        email: otherData?.email
      });
      
    } catch (e) {
      console.error('Error starting chat:', e);
      alert('Error starting chat: ' + e.message);
    }
  }

  // Recent chats
  function loadRecentChats(uid) {
    if (recentChatsUnsub) recentChatsUnsub();
    
    const ucRef = collection(db, 'userChats', uid, 'items');
    const qy = query(ucRef, orderBy('updatedAt', 'desc'));
    
    recentChatsUnsub = onSnapshot(qy, (snapshot) => {
      recentList.innerHTML = '';
      snapshot.forEach(doc => {
        const chatData = doc.data();
        const row = document.createElement('div');
        row.className = 'chat-row';
        row.dataset.chatId = chatData.chatId;
        row.innerHTML = `
          <img src="${chatData.otherPhoto || `https://api.dicebear.com/9.x/thumbs/svg?seed=${chatData.otherUid}`}" alt="pfp">
          <div>
            <div class="name">${escapeHtml(chatData.otherName || 'User')}</div>
            <div class="last">${escapeHtml(chatData.lastMessage || 'Say hi üëã')}</div>
          </div>
          <div class="muted">${timeAgo(chatData.updatedAt?.toDate?.() || new Date())}</div>
        `;
        
        row.addEventListener('click', () => {
          openChat(chatData.chatId, { 
            uid: chatData.otherUid, 
            name: chatData.otherName, 
            photo: chatData.otherPhoto 
          });
        });
        
        recentList.appendChild(row);
      });
    }, (error) => {
      console.error('Error loading recent chats:', error);
    });
  }

  // Open chat
  function openChat(chatId, other) {
    console.log('Opening chat:', chatId);
    activeChatId = chatId;
    pageTitle.textContent = other?.name || 'Chat';
    pageSub.textContent = other?.email || '';
    activateView(chatView);
    emptyState.style.display = 'none';
    composer.hidden = false;
    sidebar.classList.remove('open');
    
    if (messagesUnsub) messagesUnsub();
    
    const messagesRef = collection(db, 'chats', chatId, 'messages');
    const q = query(messagesRef, orderBy('createdAt', 'asc'));
    
    messagesUnsub = onSnapshot(q, (snapshot) => {
      renderMessages(snapshot);
    });
    
    // Initial load
    getDocs(q).then(snapshot => renderMessages(snapshot));
  }

  // Send message
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || !activeChatId) return;
    
    const me = auth.currentUser;
    if (!me) return;
    
    try {
      messageInput.value = '';
      messageInput.disabled = true;
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';
      
      // Add message
      const messagesRef = collection(db, 'chats', activeChatId, 'messages');
      await addDoc(messagesRef, {
        text,
        senderId: me.uid,
        createdAt: serverTimestamp()
      });
      
      // Update chat metadata
      await updateChatLastMessage(activeChatId, text, me.uid);
      
      console.log('Message sent!');
    } catch (e) {
      console.error('Error sending message:', e);
      messageInput.value = text;
      alert('Failed to send message: ' + e.message);
    } finally {
      messageInput.disabled = false;
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send';
      messageInput.focus();
    }
  }

  // Profile
  async function loadProfile() {
    const me = auth.currentUser;
    if (!me) return;
    try {
      const ref = doc(db, 'users', me.uid);
      const snap = await getDoc(ref);
      const data = snap.data() || {};
      profileName.value = data.name || me.displayName || '';
      profilePhoto.value = data.photoURL || me.photoURL || '';
      profileBio.value = data.bio || '';
    } catch (e) {
      console.error('Error loading profile:', e);
    }
  }

  saveProfileBtn.addEventListener('click', async () => {
    const me = auth.currentUser;
    if (!me) return;
    
    const name = profileName.value.trim();
    const photoURL = profilePhoto.value.trim();
    const bio = profileBio.value.trim();
    
    try {
      await updateProfile(me, { 
        displayName: name || me.displayName, 
        photoURL: photoURL || me.photoURL 
      });
      
      await setDoc(doc(db, 'users', me.uid), {
        name: me.displayName,
        email: me.email,
        photoURL: me.photoURL,
        bio,
        updatedAt: serverTimestamp()
      }, { merge: true });
      
      meName.textContent = me.displayName;
      meAvatar.src = me.photoURL;
      alert('Profile updated!');
    } catch (e) {
      console.error('Error saving profile:', e);
      alert('Error: ' + e.message);
    }
  });

  // Invite button
  inviteBtn.addEventListener('click', () => {
    const url = location.href;
    window.open(`mailto:?subject=Join me on Chatter&body=Let's chat: ${url}`);
  });
</script>
</body>
</html>